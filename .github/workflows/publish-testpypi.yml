name: Publish to TestPyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use pyproject.toml version)'
        required: false
        type: string
  push:
    tags:
      - 'test-v*.*.*'

permissions:
  contents: read

jobs:
  build-and-publish:
    name: Build and Publish to TestPyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v7

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Build package
        run: uv build

      - name: Verify build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh dist/
          echo ""
          echo "Wheel contents:"
          unzip -l dist/*.whl | head -20

      - name: Publish to TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          uv publish \
            --publish-url https://test.pypi.org/legacy/ \
            --token $UV_PUBLISH_TOKEN

      - name: Verify publication
        run: |
          echo "Package published to TestPyPI!"
          echo ""
          echo "Test installation with:"
          echo "  pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ finbot"
          echo ""
          echo "View package at:"
          echo "  https://test.pypi.org/project/finbot/"

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: testpypi-dist
          path: dist/
          retention-days: 7
